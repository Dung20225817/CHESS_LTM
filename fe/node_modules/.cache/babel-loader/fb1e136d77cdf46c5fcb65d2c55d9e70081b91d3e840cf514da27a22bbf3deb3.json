{"ast":null,"code":"var _s = $RefreshSig$();\n// ...existing code...\nimport { useEffect, useRef, useState } from \"react\";\nfunction makeWsUrl() {\n  const proto = window.location.protocol === \"https:\" ? \"wss:\" : \"ws:\";\n  const envHost = process.env.REACT_APP_WS_HOST;\n  const host = envHost || `${window.location.hostname}:8765`;\n  return `${proto}//${host}`;\n}\n\n/**\r\n * Hook quản lý WebSocket kết nối tới Bridge cho phòng cờ.\r\n * - roomId: id phòng, nếu rỗng sẽ ngắt kết nối\r\n * - onUpdate: callback nhận state / gameOver\r\n */\nexport default function useChessSocket(roomId, onUpdate) {\n  _s();\n  const wsRef = useRef(null);\n  const [connected, setConnected] = useState(false);\n  const [playerColor, setPlayerColor] = useState(null);\n  useEffect(() => {\n    // if no room => close connection\n    if (!roomId) {\n      if (wsRef.current) {\n        try {\n          wsRef.current.close();\n        } catch {}\n        wsRef.current = null;\n      }\n      setConnected(false);\n      setPlayerColor(null);\n      return;\n    }\n    const url = makeWsUrl();\n    const ws = new WebSocket(url);\n    wsRef.current = ws;\n    const cleanup = () => {\n      try {\n        ws.close();\n      } catch {}\n      if (wsRef.current === ws) wsRef.current = null;\n      setConnected(false);\n    };\n    const parseAndDispatch = raw => {\n      // support multiple JSON objects possibly concatenated\n      const matches = raw.match(/{[^}]+}/g);\n      if (!matches) return;\n      for (const jsonStr of matches) {\n        try {\n          const data = JSON.parse(jsonStr);\n          if (!data || !data.type) continue;\n          switch (data.type) {\n            case \"assignColor\":\n              if (data.color === \"white\" || data.color === \"black\") {\n                setPlayerColor(data.color);\n              }\n              break;\n            case \"state\":\n              onUpdate(data.fen || \"\", data.turn || \"white\", null, undefined);\n              break;\n            case \"gameOver\":\n              onUpdate(\"\", \"white\", data.winner || null, data.reason);\n              break;\n            case \"error\":\n              // optional: could forward to UI via onUpdate with special payload\n              console.warn(\"Server error:\", data.msg);\n              break;\n            default:\n              // handle moves or other messages forwarded from C server\n              // for example move updates might come as \"move\" / \"fen\" / \"turn\"\n              if (data.type === \"move\" || data.type === \"update\") {\n                onUpdate(data.fen || \"\", data.turn || \"white\", null, undefined);\n              } else {\n                console.debug(\"Unknown ws message type:\", data.type, data);\n              }\n          }\n        } catch (err) {\n          console.warn(\"Invalid JSON from ws:\", jsonStr, err);\n        }\n      }\n    };\n    ws.onopen = () => {\n      setConnected(true);\n      // join room immediately\n      try {\n        ws.send(JSON.stringify({\n          type: \"join\",\n          room: roomId\n        }));\n      } catch (e) {\n        console.warn(\"WS send join failed\", e);\n      }\n    };\n    ws.onmessage = ev => {\n      const data = typeof ev.data === \"string\" ? ev.data : \"\";\n      parseAndDispatch(data);\n    };\n    ws.onerror = ev => {\n      console.warn(\"WebSocket error\", ev);\n    };\n    ws.onclose = () => {\n      cleanup();\n    };\n\n    // cleanup on unmount or roomId change\n    return () => {\n      try {\n        ws.close();\n      } catch {}\n      if (wsRef.current === ws) wsRef.current = null;\n      setConnected(false);\n    };\n  }, [roomId, onUpdate]);\n  const sendMove = move => {\n    const ws = wsRef.current;\n    if (!ws || ws.readyState !== WebSocket.OPEN) return false;\n    try {\n      ws.send(JSON.stringify({\n        type: \"move\",\n        move\n      }));\n      return true;\n    } catch {\n      return false;\n    }\n  };\n  const sendChat = text => {\n    const ws = wsRef.current;\n    if (!ws || ws.readyState !== WebSocket.OPEN) return false;\n    try {\n      ws.send(JSON.stringify({\n        type: \"chat\",\n        text\n      }));\n      return true;\n    } catch {\n      return false;\n    }\n  };\n  const leaveRoom = () => {\n    const ws = wsRef.current;\n    if (ws) {\n      try {\n        ws.send(JSON.stringify({\n          type: \"leave\",\n          room: roomId\n        }));\n      } catch {}\n      try {\n        ws.close();\n      } catch {}\n      wsRef.current = null;\n    }\n    setConnected(false);\n    setPlayerColor(null);\n  };\n  return {\n    connected,\n    playerColor,\n    sendMove,\n    sendChat,\n    leaveRoom\n  };\n}\n// ...existing code...\n_s(useChessSocket, \"PBhS3SqUDehSqPCXbXs+nnyqy/U=\");","map":{"version":3,"names":["useEffect","useRef","useState","makeWsUrl","proto","window","location","protocol","envHost","process","env","REACT_APP_WS_HOST","host","hostname","useChessSocket","roomId","onUpdate","_s","wsRef","connected","setConnected","playerColor","setPlayerColor","current","close","url","ws","WebSocket","cleanup","parseAndDispatch","raw","matches","match","jsonStr","data","JSON","parse","type","color","fen","turn","undefined","winner","reason","console","warn","msg","debug","err","onopen","send","stringify","room","e","onmessage","ev","onerror","onclose","sendMove","move","readyState","OPEN","sendChat","text","leaveRoom"],"sources":["D:/LTM/CHESS/fe/src/components/context/useChessSocket.ts"],"sourcesContent":["// ...existing code...\r\nimport { useEffect, useRef, useState } from \"react\";\r\n\r\ntype UpdateCallback = (fen: string, turn: string, gameOver: string | null, reason?: string) => void;\r\n\r\nfunction makeWsUrl(): string {\r\n  const proto = window.location.protocol === \"https:\" ? \"wss:\" : \"ws:\";\r\n  const envHost = process.env.REACT_APP_WS_HOST;\r\n  const host = envHost || `${window.location.hostname}:8765`;\r\n  return `${proto}//${host}`;\r\n}\r\n\r\n/**\r\n * Hook quản lý WebSocket kết nối tới Bridge cho phòng cờ.\r\n * - roomId: id phòng, nếu rỗng sẽ ngắt kết nối\r\n * - onUpdate: callback nhận state / gameOver\r\n */\r\nexport default function useChessSocket(roomId: string, onUpdate: UpdateCallback) {\r\n  const wsRef = useRef<WebSocket | null>(null);\r\n  const [connected, setConnected] = useState(false);\r\n  const [playerColor, setPlayerColor] = useState<\"white\" | \"black\" | null>(null);\r\n\r\n  useEffect(() => {\r\n    // if no room => close connection\r\n    if (!roomId) {\r\n      if (wsRef.current) {\r\n        try { wsRef.current.close(); } catch {}\r\n        wsRef.current = null;\r\n      }\r\n      setConnected(false);\r\n      setPlayerColor(null);\r\n      return;\r\n    }\r\n\r\n    const url = makeWsUrl();\r\n    const ws = new WebSocket(url);\r\n    wsRef.current = ws;\r\n\r\n    const cleanup = () => {\r\n      try { ws.close(); } catch {}\r\n      if (wsRef.current === ws) wsRef.current = null;\r\n      setConnected(false);\r\n    };\r\n\r\n    const parseAndDispatch = (raw: string) => {\r\n      // support multiple JSON objects possibly concatenated\r\n      const matches = raw.match(/{[^}]+}/g);\r\n      if (!matches) return;\r\n      for (const jsonStr of matches) {\r\n        try {\r\n          const data = JSON.parse(jsonStr);\r\n          if (!data || !data.type) continue;\r\n          switch (data.type) {\r\n            case \"assignColor\":\r\n              if (data.color === \"white\" || data.color === \"black\") {\r\n                setPlayerColor(data.color);\r\n              }\r\n              break;\r\n            case \"state\":\r\n              onUpdate(data.fen || \"\", data.turn || \"white\", null, undefined);\r\n              break;\r\n            case \"gameOver\":\r\n              onUpdate(\"\", \"white\", data.winner || null, data.reason);\r\n              break;\r\n            case \"error\":\r\n              // optional: could forward to UI via onUpdate with special payload\r\n              console.warn(\"Server error:\", data.msg);\r\n              break;\r\n            default:\r\n              // handle moves or other messages forwarded from C server\r\n              // for example move updates might come as \"move\" / \"fen\" / \"turn\"\r\n              if (data.type === \"move\" || data.type === \"update\") {\r\n                onUpdate(data.fen || \"\", data.turn || \"white\", null, undefined);\r\n              } else {\r\n                console.debug(\"Unknown ws message type:\", data.type, data);\r\n              }\r\n          }\r\n        } catch (err) {\r\n          console.warn(\"Invalid JSON from ws:\", jsonStr, err);\r\n        }\r\n      }\r\n    };\r\n\r\n    ws.onopen = () => {\r\n      setConnected(true);\r\n      // join room immediately\r\n      try {\r\n        ws.send(JSON.stringify({ type: \"join\", room: roomId }));\r\n      } catch (e) {\r\n        console.warn(\"WS send join failed\", e);\r\n      }\r\n    };\r\n\r\n    ws.onmessage = (ev) => {\r\n      const data = typeof ev.data === \"string\" ? ev.data : \"\";\r\n      parseAndDispatch(data);\r\n    };\r\n\r\n    ws.onerror = (ev) => {\r\n      console.warn(\"WebSocket error\", ev);\r\n    };\r\n\r\n    ws.onclose = () => {\r\n      cleanup();\r\n    };\r\n\r\n    // cleanup on unmount or roomId change\r\n    return () => {\r\n      try { ws.close(); } catch {}\r\n      if (wsRef.current === ws) wsRef.current = null;\r\n      setConnected(false);\r\n    };\r\n  }, [roomId, onUpdate]);\r\n\r\n  const sendMove = (move: string) => {\r\n    const ws = wsRef.current;\r\n    if (!ws || ws.readyState !== WebSocket.OPEN) return false;\r\n    try {\r\n      ws.send(JSON.stringify({ type: \"move\", move }));\r\n      return true;\r\n    } catch {\r\n      return false;\r\n    }\r\n  };\r\n\r\n  const sendChat = (text: string) => {\r\n    const ws = wsRef.current;\r\n    if (!ws || ws.readyState !== WebSocket.OPEN) return false;\r\n    try {\r\n      ws.send(JSON.stringify({ type: \"chat\", text }));\r\n      return true;\r\n    } catch {\r\n      return false;\r\n    }\r\n  };\r\n\r\n  const leaveRoom = () => {\r\n    const ws = wsRef.current;\r\n    if (ws) {\r\n      try { ws.send(JSON.stringify({ type: \"leave\", room: roomId })); } catch {}\r\n      try { ws.close(); } catch {}\r\n      wsRef.current = null;\r\n    }\r\n    setConnected(false);\r\n    setPlayerColor(null);\r\n  };\r\n\r\n  return {\r\n    connected,\r\n    playerColor,\r\n    sendMove,\r\n    sendChat,\r\n    leaveRoom,\r\n  };\r\n}\r\n// ...existing code..."],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}